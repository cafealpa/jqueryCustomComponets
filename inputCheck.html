<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SI 프로젝트 공통 컴포넌트 테스트</title>
    <!-- JQuery CDN (폐쇄망에서는 로컬 파일로 대체하세요) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        /* SI 프로젝트 스타일의 간단한 CSS */
        body { font-family: 'Malgun Gothic', 'Dotum', sans-serif; font-size: 14px; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { font-size: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; color: #333; }
        
        /* 테이블 스타일 폼 */
        .form-table { width: 100%; border-collapse: collapse; border-top: 2px solid #5d5d5d; }
        .form-table th { background-color: #f0f0f0; border-bottom: 1px solid #ddd; padding: 10px; text-align: left; width: 150px; font-weight: bold; color: #333; }
        .form-table td { border-bottom: 1px solid #ddd; padding: 8px 10px; }
        
        /* 인풋 스타일 */
        input[type="text"], select { height: 32px; padding: 0 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; outline: none; transition: border-color 0.2s; }
        input[type="text"]:focus { border-color: #007bff; }
        input[readonly] { background-color: #f9f9f9; color: #777; }
        
        /* 유틸리티 클래스 */
        .required::before { content: '*'; color: #e74c3c; margin-right: 4px; }
        .text-right { text-align: right; }
        .w-50 { width: 50% !important; }
        .w-30 { width: 30% !important; }
        .btn-area { margin-top: 20px; text-align: center; }
        
        /* 버튼 스타일 */
        button { padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; min-width: 80px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }

        /* [추가] 로그 확인용 스타일 */
        #logArea { margin-top: 20px; padding: 15px; background: #333; color: #0f0; font-family: 'Consolas', monospace; font-size: 12px; height: 150px; overflow-y: auto; border-radius: 4px; }
        .log-time { color: #888; margin-right: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>임직원 정보 등록 (테스트)</h1>
    
    <table class="form-table">
        <tr>
            <th class="required">성명</th>
            <td><input type="text" id="userName" class="w-50" placeholder="한글/영문 입력"></td>
        </tr>
        <tr>
            <th class="required">사번 (숫자)</th>
            <td><input type="text" id="empId" class="w-30" placeholder="숫자만 입력"></td>
        </tr>
        <tr>
            <th class="required">휴대전화</th>
            <td><input type="text" id="mobileNo" class="w-50" placeholder="숫자만 입력 (자동 하이픈)"></td>
        </tr>
        <tr>
            <th>이메일</th>
            <td><input type="text" id="email" placeholder="example@company.com"></td>
        </tr>
        <tr>
            <th class="required">연봉 (계약)</th>
            <td><input type="text" id="salary" class="text-right w-50" placeholder="숫자만 입력 (자동 콤마)"> 원</td>
        </tr>
        <tr>
            <th>입사일자</th>
            <td><input type="text" id="joinDate" class="w-30" placeholder="YYYY-MM-DD (자동 포맷)"></td>
        </tr>
    </table>

    <!-- [추가] 다중 AJAX 테스트 버튼 -->
    <div class="btn-area" style="border-top: 1px dashed #ddd; padding-top: 20px; margin-top: 20px;">
        <h3>[개발자 도구] 비동기 호출 테스트</h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
            부서정보(1초), 공통코드(2초), 사용자설정(1.5초)을 동시에 호출하여<br>
            가장 늦은 2초 뒤에 모든 데이터를 합쳐서 처리합니다.
        </p>
        <button type="button" class="btn-secondary" id="btnMultiTest" style="background-color: #17a2b8;">다중 AJAX 호출 (Mock)</button>
    </div>

    <!-- [추가] 로그 영역 -->
    <div id="logArea">준비 완료...</div>

    <div class="btn-area">
        <button type="button" class="btn-secondary" onclick="window.location.reload()">초기화</button>
        <button type="button" class="btn-primary" id="btnSave">저장</button>
    </div>
</div>

<script>
/**
 * [Common] SI 공통 스크립트 영역
 * (실제 프로젝트에서는 common.js 파일로 분리하세요)
 */
(function($) {
    // ... (기존 checkValidation, autoFormat 함수 생략) ...

    /**
     * [UI Component] 입력값 유효성 검사 (Validation Check)
     */
    $.fn.checkValidation = function(options) {
        var settings = $.extend({
            name: '항목', required: false, maxLength: 0, numberOnly: false, regex: null, regexMsg: '형식이 올바르지 않습니다.'
        }, options);

        var $this = $(this);
        var val = $.trim($this.val());
        var result = { isValid: true, msg: '' };

        // 필수 체크
        if (settings.required && (val === '' || val === null)) {
            return { isValid: false, msg: settings.name + '은(는) 필수 입력 항목입니다.' };
        }
        if (val === '') return result;

        // 길이 체크
        if (settings.maxLength > 0 && val.length > settings.maxLength) {
            return { isValid: false, msg: settings.name + '은(는) ' + settings.maxLength + '자 이내로 입력해주세요.' };
        }

        // 숫자 전용 체크
        if (settings.numberOnly) {
            if (!/^[0-9]+$/.test(val.replace(/,/g, ''))) {
                return { isValid: false, msg: settings.name + '은(는) 숫자만 입력 가능합니다.' };
            }
        }

        // 정규식 체크
        if (settings.regex) {
            var pattern = (typeof settings.regex === 'string') ? new RegExp(settings.regex) : settings.regex;
            if (!pattern.test(val)) {
                return { isValid: false, msg: settings.regexMsg };
            }
        }
        return result;
    };

    /**
     * [UI Component] 입력값 자동 포맷팅 (Auto Formatting)
     */
    $.fn.autoFormat = function(type) {
        return this.each(function() {
            var $this = $(this);
            $this.on('input keyup', function() {
                var val = $this.val();
                var cleanVal = val.replace(/[^0-9]/g, '');
                if (!cleanVal) { $this.val(''); return; }
                
                var formattedVal = '';
                switch (type) {
                    case 'phone':
                        if (cleanVal.length < 4) formattedVal = cleanVal;
                        else if (cleanVal.length < 7) formattedVal = cleanVal.substr(0, 3) + '-' + cleanVal.substr(3);
                        else if (cleanVal.length < 11) {
                            formattedVal = (cleanVal.substr(0, 2) === '02') 
                                ? cleanVal.substr(0, 2) + '-' + cleanVal.substr(2, 3) + '-' + cleanVal.substr(5)
                                : cleanVal.substr(0, 3) + '-' + cleanVal.substr(3, 3) + '-' + cleanVal.substr(6);
                        } else {
                            formattedVal = (cleanVal.substr(0, 2) === '02')
                                ? cleanVal.substr(0, 2) + '-' + cleanVal.substr(2, 4) + '-' + cleanVal.substr(6)
                                : cleanVal.substr(0, 3) + '-' + cleanVal.substr(3, 4) + '-' + cleanVal.substr(7);
                        }
                        if (formattedVal.length > 13) formattedVal = formattedVal.substring(0, 13);
                        break;
                    case 'money':
                        formattedVal = parseInt(cleanVal, 10).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        break;
                    case 'date':
                        if (cleanVal.length < 5) formattedVal = cleanVal;
                        else if (cleanVal.length < 7) formattedVal = cleanVal.substr(0, 4) + '-' + cleanVal.substr(4);
                        else formattedVal = cleanVal.substr(0, 4) + '-' + cleanVal.substr(4, 2) + '-' + cleanVal.substr(6);
                        if (formattedVal.length > 10) formattedVal = formattedVal.substring(0, 10);
                        break;
                    case 'number':
                        formattedVal = cleanVal; break;
                }
                $this.val(formattedVal);
            });
        });
    };

    /**
     * [System] 다중 AJAX 호출 처리기 (Multi Ajax Caller)
     * * @description
     * 여러 개의 AJAX 요청을 병렬로 전송하고, 모든 요청이 완료될 때까지 기다린 후
     * 결과를 하나의 배열로 반환합니다. 하나라도 실패하면 fail로 떨어집니다.
     * * * @param {Array} requests - $.ajax 설정 객체들의 배열
     * * @returns {Promise} - 모든 요청의 결과 데이터 배열 [result1, result2, ...]
     * * * @example
     * $.multiAjax([
     * { url: '/api/dept', type: 'GET' },
     * { url: '/api/code', type: 'GET' }
     * ]).then(function(results) {
     * var deptList = results[0];
     * var codeList = results[1];
     * });
     */
    $.multiAjax = function(requests) {
        var ajaxCalls = [];

        // 1. 요청 배열을 순회하며 실제 AJAX 호출(또는 Mock 호출) 생성
        $.each(requests, function(i, req) {
            // [Test용] URL에 'mock'이 포함되면 가짜 지연 응답 생성 (실제 사용시 제거 불필요)
            if (req.url && req.url.indexOf('mock') > -1) {
                var dfd = $.Deferred();
                var delay = req.delay || 1000;
                logToScreen('[' + req.name + '] 요청 시작 (예상시간: ' + delay/1000 + '초)');
                
                setTimeout(function() {
                    logToScreen('[' + req.name + '] 응답 완료!');
                    dfd.resolve(req.mockData || {}); // 성공 처리
                }, delay);
                ajaxCalls.push(dfd.promise());
            } else {
                // [Real] 실제 서버 통신
                ajaxCalls.push($.ajax(req));
            }
        });

        // 2. $.when을 사용하여 모든 Promise가 해결될 때까지 대기
        return $.when.apply($, ajaxCalls).then(function() {
            var results = [];
            
            // 3. 결과값 정규화 (Normalization)
            // $.when은 인자가 1개일 때와 여러 개일 때 arguments 구조가 다릅니다.
            if (ajaxCalls.length === 1) {
                // 요청이 1개인 경우: arguments[0]이 데이터
                results.push(arguments[0]);
            } else {
                // 요청이 여러 개인 경우: arguments[i][0]이 데이터 (jQuery Ajax 기준)
                // Mock 객체의 경우 arguments[i] 자체가 데이터일 수 있으므로 분기 처리
                for (var i = 0; i < arguments.length; i++) {
                    var arg = arguments[i];
                    // jQuery Ajax 응답은 [data, status, xhr] 배열임. 데이터는 0번째.
                    if (Array.isArray(arg) && arg.length === 3 && arg[1] === 'success') {
                        results.push(arg[0]);
                    } else {
                        // Mock 데이터는 배열이 아닐 수 있음
                        results.push(arg);
                    }
                }
            }
            return results; // 정제된 데이터 배열 반환
        });
    };

})(jQuery);

// 3. 유틸리티: 순수 데이터 추출
function getCleanVal(id) {
    return $(id).val().replace(/[^0-9]/g, '');
}

// [Test용] 화면 로그 출력 함수
function logToScreen(msg) {
    var $log = $('#logArea');
    var time = new Date().toLocaleTimeString();
    $log.append('<div><span class="log-time">[' + time + ']</span>' + msg + '</div>');
    $log.scrollTop($log[0].scrollHeight);
}

/**
 * [Page] 화면별 스크립트
 */
$(document).ready(function() {

    // [Step 1] 입력 마스크 적용 (Input Masking)
    $('#empId').autoFormat('number');    // 숫자만
    $('#mobileNo').autoFormat('phone');  // 전화번호
    $('#salary').autoFormat('money');    // 금액
    $('#joinDate').autoFormat('date');   // 날짜

    // [Step 2] 다중 AJAX 테스트 버튼 이벤트
    $('#btnMultiTest').on('click', function() {
        $('#logArea').empty();
        logToScreen('--- 다중 호출 시작 (병렬 처리) ---');

        // 여러 개의 API를 동시에 호출한다고 가정
        var ajaxRequests = [
            { 
                name: '부서목록', 
                url: 'mock/deptList', 
                delay: 1000, // 1초 지연
                mockData: [ { id: 'D01', name: '개발팀' }, { id: 'D02', name: '기획팀' } ] 
            },
            { 
                name: '공통코드', 
                url: 'mock/commonCode', 
                delay: 2000, // 2초 지연 (가장 느림)
                mockData: { positions: ['사원', '대리', '과장'], status: ['재직', '휴직'] } 
            },
            { 
                name: '사용자설정', 
                url: 'mock/userConfig', 
                delay: 1500, // 1.5초 지연
                mockData: { theme: 'dark', alarm: true } 
            }
        ];

        // 공통 함수 호출
        $.multiAjax(ajaxRequests).then(function(results) {
            logToScreen('--- 모든 통신 완료 (All Done) ---');
            
            var deptList = results[0];
            var commCode = results[1];
            var userConfig = results[2];

            console.log('부서목록:', deptList);
            console.log('공통코드:', commCode);
            console.log('사용자설정:', userConfig);

            logToScreen('데이터 병합 완료. 콘솔(F12)에서 상세 데이터를 확인하세요.');
            
            // 화면에 데이터 적용 예시
            alert("통신 완료!\n\n부서 개수: " + deptList.length + "\n직급 목록: " + commCode.positions.join(', '));
        }).fail(function() {
            logToScreen('통신 중 오류가 발생했습니다.');
            alert('오류 발생');
        });
    });

    // [Step 3] 저장 버튼 이벤트
    $('#btnSave').on('click', function() {
        
        // --- 1. 성명 검증 (필수, 5자 이내)
        var v1 = $('#userName').checkValidation({
            name: '성명', required: true, maxLength: 5
        });
        if(!v1.isValid) { alert(v1.msg); $('#userName').focus(); return; }

        // --- 2. 사번 검증 (필수, 숫자만)
        var v2 = $('#empId').checkValidation({
            name: '사번', required: true, numberOnly: true
        });
        if(!v2.isValid) { alert(v2.msg); $('#empId').focus(); return; }

        // --- 3. 휴대전화 검증 (필수, 정규식)
        var v3 = $('#mobileNo').checkValidation({
            name: '휴대전화', required: true, 
            regex: /^01([0|1|6|7|8|9])-?([0-9]{3,4})-?([0-9]{4})$/,
            regexMsg: '휴대전화 형식이 올바르지 않습니다. (010-XXXX-XXXX)'
        });
        if(!v3.isValid) { alert(v3.msg); $('#mobileNo').focus(); return; }

        // --- 4. 이메일 검증 (선택입력, 형식이 있다면 체크)
        var v4 = $('#email').checkValidation({
            name: '이메일', required: false,
            regex: /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/,
            regexMsg: '이메일 주소를 확인해주세요.'
        });
        if(!v4.isValid) { alert(v4.msg); $('#email').focus(); return; }

        // --- 5. 연봉 검증 (필수)
        var v5 = $('#salary').checkValidation({
            name: '연봉', required: true
        });
        if(!v5.isValid) { alert(v5.msg); $('#salary').focus(); return; }

        // --- 6. 입사일자 검증 (선택, 날짜 형식 완벽 체크)
        // 단순 길이 체크가 아니라 실제 존재하는 날짜인지 정규식 활용
        var v6 = $('#joinDate').checkValidation({
            name: '입사일자', required: false,
            regex: /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/,
            regexMsg: '유효한 날짜가 아닙니다. (YYYY-MM-DD)'
        });
        if(!v6.isValid) { alert(v6.msg); $('#joinDate').focus(); return; }

        // [Step 4] 데이터 전송 준비 (콤마 제거 등)
        var saveData = {
            user_name: $('#userName').val(),
            emp_id: $('#empId').val(),
            mobile_no: getCleanVal('#mobileNo'), // 01012341234
            email: $('#email').val(),
            salary: getCleanVal('#salary'),      // 50000000
            join_date: getCleanVal('#joinDate')  // 20251211
        };

        // 결과 확인
        alert('유효성 검사 통과!\n\n[서버 전송 데이터]\n' + JSON.stringify(saveData, null, 2));
        console.log(saveData);
    });
});
</script>

</body>
</html>