<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajax Cascading SelectBox</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 로딩 인디케이터 스타일 */
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            display: none; /* 기본 숨김 */
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">단계별 카테고리 선택 (AJAX)</h2>

        <!-- Select Box 영역 -->
        <div class="space-y-4">
            
            <!-- 1단계 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">대분류 (Depth 1)</label>
                <div class="flex items-center">
                    <select id="sel-step-1" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">선택해주세요</option>
                    </select>
                    <div id="loader-1" class="loading-spinner"></div>
                </div>
            </div>

            <!-- 2단계 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">중분류 (Depth 2)</label>
                <div class="flex items-center">
                    <select id="sel-step-2" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" disabled>
                        <option value="">상위 항목을 선택하세요</option>
                    </select>
                    <div id="loader-2" class="loading-spinner"></div>
                </div>
            </div>

            <!-- 3단계 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">소분류 (Depth 3)</label>
                <div class="flex items-center">
                    <select id="sel-step-3" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" disabled>
                        <option value="">상위 항목을 선택하세요</option>
                    </select>
                    <div id="loader-3" class="loading-spinner"></div>
                </div>
            </div>

        </div>

        <!-- 결과 확인용 -->
        <div class="mt-8 p-4 bg-gray-50 rounded border text-sm text-gray-600">
            <p><strong>선택 경로:</strong> <span id="selection-result" class="text-blue-600 font-bold">-</span></p>
        </div>
    </div>

    <script>
        /**
         * [Mock Server] 실제 서버 없이 AJAX 동작을 흉내내는 함수
         * 실제 구현 시에는 이 부분을 $.ajax({ url: ... }) 로 대체하면 됩니다.
         */
        function mockAjaxService(parentId, depth) {
            return new Promise((resolve, reject) => {
                // 네트워크 지연 시뮬레이션 (0.3초)
                setTimeout(() => {
                    // 데이터베이스 정의 (ParentID에 따라 종속 데이터 리턴)
                    const db = {
                        // Depth 1 (Root)
                        'root': [
                            { id: 'elec', name: '전자제품' },
                            { id: 'cloth', name: '의류' },
                            { id: 'food', name: '식품' }
                        ],
                        // Depth 2
                        'elec': [
                            { id: 'phone', name: '스마트폰' },
                            { id: 'laptop', name: '노트북' }
                        ],
                        'cloth': [
                            { id: 'top', name: '상의' },
                            { id: 'bottom', name: '하의' }
                        ],
                        'food': [
                            { id: 'fresh', name: '신선식품' },
                            { id: 'process', name: '가공식품' }
                        ],
                        // Depth 3
                        'phone': [{ id: 'galaxy', name: '갤럭시' }, { id: 'iphone', name: '아이폰' }],
                        'laptop': [{ id: 'macbook', name: '맥북' }, { id: 'gram', name: '그램' }],
                        'top': [{ id: 'tshirt', name: '티셔츠' }, { id: 'shirt', name: '셔츠' }],
                        'bottom': [{ id: 'jean', name: '청바지' }, { id: 'slacks', name: '슬랙스' }]
                    };

                    const data = db[parentId] || []; // 데이터 없으면 빈 배열
                    console.log(`[AJAX] 요청: parentId=${parentId}, depth=${depth} => 응답: ${data.length}건`);
                    resolve(data);
                }, 300);
            });
        }

        /**
         * [Plugin] Cascading Select Manager
         */
        const CascadingSelect = {
            init: function(options) {
                this.selectors = options.selectors; // SelectBox ID 배열 ['#id1', '#id2'...]
                this.maxDepth = options.maxDepth || this.selectors.length; // 최대 깊이 제한
                
                // 1) 첫 번째 SelectBox 로드
                this.loadLevel(0, 'root'); 
                
                // 2) 이벤트 바인딩
                this.bindEvents();
            },

            // 레벨별 데이터 로드 (AJAX 호출)
            loadLevel: function(levelIndex, parentId) {
                // 설정된 깊이 제한을 넘어가면 중단
                if (levelIndex >= this.maxDepth) return;

                const targetSelector = this.selectors[levelIndex];
                const $target = $(targetSelector);
                const $loader = $(`#loader-${levelIndex + 1}`); // 로딩 아이콘 (선택 사항)

                // UI 초기화 (로딩 중 표시)
                $target.prop('disabled', true);
                $loader.show();

                // ---------------------------------------------------------
                // 1) Ajax로 data list 조회
                // ---------------------------------------------------------
                mockAjaxService(parentId, levelIndex + 1)
                    .then((data) => {
                        // 2) data list로 selectbox 생성
                        $target.empty().append('<option value="">선택해주세요</option>');

                        if (data.length > 0) {
                            data.forEach(item => {
                                $target.append(`<option value="${item.id}">${item.name}</option>`);
                            });
                            $target.prop('disabled', false); // 데이터 있으면 활성화
                        } else {
                             $target.append('<option value="">데이터 없음</option>');
                        }
                    })
                    .catch(err => {
                        console.error('Data Load Error', err);
                        $target.append('<option value="">로딩 실패</option>');
                    })
                    .finally(() => {
                        $loader.hide();
                    });
            },

            // 하위 SelectBox들 초기화 (값이 변경되었을 때 하위 레벨 리셋)
            resetChildren: function(startIndex) {
                for (let i = startIndex; i < this.selectors.length; i++) {
                    const $el = $(this.selectors[i]);
                    $el.empty().append('<option value="">상위 항목을 선택하세요</option>');
                    $el.prop('disabled', true);
                }
                this.updateResult(); // 결과 텍스트 갱신
            },

            // 이벤트 리스너 등록
            bindEvents: function() {
                const self = this;

                this.selectors.forEach((selector, index) => {
                    // 마지막 레벨은 change 이벤트가 다음 레벨을 부르지 않으므로 제외 가능하나, 결과 출력을 위해 바인딩
                    $(document).on('change', selector, function() {
                        const selectedValue = $(this).val();
                        const nextLevel = index + 1;

                        // 1. 현재 레벨보다 하위 레벨들은 모두 초기화
                        self.resetChildren(nextLevel);

                        // 2. 값이 있고, 다음 레벨이 존재하며, maxDepth 제한 내라면 -> Ajax 조회
                        // 3) 설정으로 첫번째 selectbox의 데이터로 ajax조회. 두번째 selectbox 생성
                        if (selectedValue && nextLevel < self.selectors.length && nextLevel < self.maxDepth) {
                            self.loadLevel(nextLevel, selectedValue);
                        }

                        self.updateResult();
                    });
                });
            },

            // 단순 UI 업데이트용 헬퍼
            updateResult: function() {
                const results = [];
                this.selectors.forEach(sel => {
                    const txt = $(sel + ' option:selected').text();
                    const val = $(sel).val();
                    if (val) results.push(txt);
                });
                $('#selection-result').text(results.join(' > ') || '-');
            }
        };

        // ---------------------------------------------------------
        // 실행 코드
        // ---------------------------------------------------------
        $(document).ready(function() {
            CascadingSelect.init({
                // 제어할 SelectBox들의 ID 순서대로 배열 입력
                selectors: ['#sel-step-1', '#sel-step-2', '#sel-step-3'],
                
                // 4) 깊이 옵션 값으로 selectbox 생성 limit 설정
                // 예: 2로 설정하면 3번째 selectbox는 동작하지 않음 (데이터 로드 X)
                maxDepth: 3 
            });
        });

    </script>
</body>
</html>

